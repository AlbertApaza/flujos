<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Simulaci√≥n Ciberseguridad: Wazuh + Suricata (Cluster)</title>
    <style>
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            font-family: 'Consolas', 'Monaco', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1400px;
            background: linear-gradient(145deg, #1e1e2e 0%, #252535 100%);
            border: 2px solid #00d2ff;
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(0, 210, 255, 0.3), inset 0 0 60px rgba(0,0,0,0.5);
            padding: 20px;
            position: relative;
        }

        h1 { 
            text-align: center; 
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 10px 0; 
            font-size: 2rem; 
            text-transform: uppercase; 
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(0, 210, 255, 0.5);
        }

        /* Scenario Selector */
        .scenario-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-scenario {
            background: rgba(0, 210, 255, 0.1);
            border: 1px solid #00d2ff;
            color: #00d2ff;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            font-family: monospace;
            font-weight: bold;
        }

        .btn-scenario.active, .btn-scenario:hover {
            background: #00d2ff;
            color: #000;
            box-shadow: 0 0 15px #00d2ff;
        }
        
        svg {
            width: 100%;
            height: 650px;
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #0f0f1e 100%);
            border-radius: 10px;
            border: 2px solid #2a2a4e;
            overflow: visible;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
        }

        .cable { stroke: #4a4a6a; stroke-width: 3; fill: none; filter: drop-shadow(0 0 3px #4a4a6a); }
        .cable-mgmt { stroke: #666; stroke-width: 2; stroke-dasharray: 6,4; fill: none; }

        text { font-family: 'Segoe UI', sans-serif; pointer-events: none; user-select: none; }
        .txt-title { fill: #fff; font-weight: bold; font-size: 14px; text-anchor: middle; }
        .txt-ip { fill: #00d2ff; font-size: 11px; text-anchor: middle; font-weight: 500; }
        .txt-term { fill: #0f0; font-family: monospace; font-size: 11px; font-weight: bold; white-space: pre; }
        
        .msg-label {
            font-weight: bold;
            font-size: 13px;
            text-anchor: middle;
            animation: fadeUp 2.5s forwards;
            filter: drop-shadow(0 0 5px currentColor);
            z-index: 100;
        }
        .msg-timeout { fill: #ff4444; font-weight: 800; font-size: 14px; }
        .msg-hids { fill: #00ffff; }
        .msg-alert { fill: #ffff00; font-size: 14px; }

        @keyframes fadeUp {
            0% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-40px); }
        }

        .blink { animation: blinker 0.6s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.2; } }

        .stress-shake { 
            animation: vibrate 0.1s linear infinite both;
            transform-box: fill-box;
            transform-origin: center;
        }
        @keyframes vibrate {
            0% { transform: translate(0, 0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(2px, -2px); }
            60% { transform: translate(-2px, -2px); }
            80% { transform: translate(2px, 2px); }
            100% { transform: translate(0, 0); }
        }

        .controls {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 3fr 1fr;
            gap: 25px;
            align-items: center;
            background: linear-gradient(135deg, #252535 0%, #2a2a3e 100%);
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #00d2ff;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        .step-count { 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: #00d2ff; 
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.5);
        }
        .desc { 
            font-size: 1rem; 
            color: #ccc; 
            line-height: 1.5; 
            text-align: center;
        }
        
        button.ctrl-btn {
            background: linear-gradient(135deg, #2a2a3e, #3a3a5e);
            color: white; 
            border: 2px solid #00d2ff;
            padding: 10px 20px; 
            cursor: pointer; 
            border-radius: 8px;
            font-weight: bold; 
            transition: all 0.3s;
        }
        button.ctrl-btn:hover { 
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            color: #000; 
            transform: translateY(-2px);
        }
        button.ctrl-btn:disabled { 
            opacity: 0.3; 
            cursor: not-allowed;
            transform: none;
        }

        /* Estilos para los Logs de Wazuh en el Dashboard */
        .log-entry { font-size: 10px; fill: #fff; font-family: monospace; }
        .log-rule { font-weight: bold; fill: #ffcc00; }

    </style>
</head>
<body>

<div class="container">
    <h1>üõ°Ô∏è Laboratorio de Intrusi√≥n y Defensa (Cluster) üõ°Ô∏è</h1>

    <div class="scenario-selector">
        <button class="btn-scenario active" onclick="setScenario('privesc')">1. Escalada de Privilegios</button>
        <button class="btn-scenario" onclick="setScenario('persistence')">2. Persistencia (FIM)</button>
        <button class="btn-scenario" onclick="setScenario('logs')">3. Borrado de Logs</button>
        <button class="btn-scenario" onclick="setScenario('ddos')">4. Ataque DDoS Masivo</button>
    </div>

    <svg viewBox="0 0 1200 650" id="svgArea">
        <defs>
            <filter id="glow">
                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
            
            <linearGradient id="kali-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#00d2ff;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#3a7bd5;stop-opacity:1" />
            </linearGradient>

            <linearGradient id="server-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#444;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#222;stop-opacity:1" />
            </linearGradient>
            
            <g id="icon-kali">
                <circle cx="35" cy="35" r="32" fill="url(#kali-grad)" opacity="0.2"/>
                <path d="M35,15 Q45,10 50,20 L48,35 Q50,45 40,50 L35,45 L30,50 Q20,45 22,35 L20,20 Q25,10 35,15 M30,25 L35,30 L40,25" 
                      fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
                <circle cx="28" cy="23" r="2" fill="#ff0000"/>
                <circle cx="42" cy="23" r="2" fill="#ff0000"/>
                <text x="35" y="65" class="txt-title" fill="#00d2ff" font-size="10">KALI</text>
            </g>
            
            <g id="icon-pc">
                <rect x="0" y="0" width="45" height="35" fill="#2a2a3e" stroke="#00d2ff" stroke-width="2" rx="3"/>
                <rect x="3" y="3" width="39" height="29" fill="#0a0a1e" />
                <circle cx="22" cy="17" r="8" fill="#3a7bd5" opacity="0.3"/>
                <path d="M12,40 L33,40 L28,35 L17,35 Z" fill="#3a3a5e" stroke="#00d2ff"/>
            </g>
            
            <g id="icon-server">
                <rect x="0" y="0" width="50" height="70" fill="url(#server-grad)" stroke="#00d2ff" stroke-width="2" rx="3"/>
                <rect x="5" y="5" width="40" height="12" fill="#1a1a2e" stroke="#00d2ff" rx="2"/>
                <rect x="5" y="22" width="40" height="12" fill="#1a1a2e" stroke="#00d2ff" rx="2"/>
                <rect x="5" y="39" width="40" height="12" fill="#1a1a2e" stroke="#00d2ff" rx="2"/>
                <circle cx="40" cy="60" r="3" fill="#0f0" class="blink"/>
                <circle cx="10" cy="11" r="2" fill="#00d2ff"/>
                <circle cx="10" cy="28" r="2" fill="#00d2ff"/>
                <circle cx="10" cy="45" r="2" fill="#00d2ff"/>
            </g>

            <g id="icon-wazuh-agent">
                <circle cx="6" cy="6" r="8" fill="#00d2ff" opacity="0.3"/>
                <path d="M2,2 L10,2 L10,8 Q6,12 2,8 Z" fill="#00d2ff" stroke="#fff" stroke-width="1"/>
                <text x="6" y="7" font-size="6" fill="#fff" text-anchor="middle" font-weight="bold">W</text>
            </g>

            <radialGradient id="attack-glow">
                <stop offset="0%" style="stop-color:#ff0000;stop-opacity:0.8" />
                <stop offset="100%" style="stop-color:#ff0000;stop-opacity:0" />
            </radialGradient>
        </defs>

        <!-- CABLES -->
        <path id="path-kali" d="M580,130 L580,270" class="cable"/>
        
        <path id="path-user1" d="M180,220 L550,295" class="cable"/>
        <path id="path-user2" d="M180,320 L550,305" class="cable"/>
        <path id="path-user3" d="M180,420 L550,315" class="cable"/>

        <!-- Paths to Victims -->
        <path id="path-vic1" d="M600,330 L280,550" class="cable"/>
        <path id="path-vic2" d="M600,330 L400,550" class="cable"/>
        <path id="path-vic3" d="M600,330 L520,550" class="cable"/>
        
        <path id="path-hids-log" d="M280,550 L600,330 L900,550" class="cable-mgmt"/> 

        <path id="path-suricata" d="M620,300 L900,180" class="cable-mgmt"/>
        <path id="path-wazuh" d="M620,330 L900,550" class="cable"/>
        <path id="path-alert" d="M950,230 L950,550" class="cable-mgmt"/>
        <line x1="970" y1="550" x2="1060" y2="490" class="cable"/>

        <!-- KALI LINUX -->
        <g transform="translate(530, 30)">
            <rect x="-20" y="-15" width="140" height="130" fill="#0a0a1e" stroke="#00d2ff" stroke-width="3" rx="10" opacity="0.3"/>
            <use href="#icon-kali" x="0" y="0" transform="scale(1.2)"/>
            <text x="50" y="90" class="txt-title" fill="#fff" font-size="16">KALI LINUX</text>
            <text x="50" y="108" class="txt-ip">10.50.0.100</text>
            
            <g transform="translate(-180, 20)" id="kali-terminal" style="opacity:0">
                <rect width="340" height="65" fill="#000" stroke="#00d2ff" stroke-width="2" rx="5"/>
                <rect width="340" height="20" fill="#00d2ff" rx="5 5 0 0"/>
                <text x="10" y="14" class="txt-term" fill="#000" font-size="10" font-weight="bold">‚óè ‚óè ‚óè root@kali</text>
                <text x="15" y="40" class="txt-term" id="term-line1">root@kali:~#</text>
                <text x="15" y="55" class="txt-term" id="term-line2" fill="#0f0">_</text>
            </g>
        </g>

        <!-- ROUTER / FIREWALL -->
        <g transform="translate(530, 280)">
            <rect x="-30" y="0" width="140" height="50" fill="#2a2a3e" rx="8" stroke="#00d2ff" stroke-width="2"/>
            <text x="40" y="28" class="txt-title">ROUTER / FW</text>
            <circle cx="15" cy="25" r="4" fill="#0f0" class="blink"/>
            <circle cx="25" cy="25" r="4" fill="#00d2ff" class="blink"/>
        </g>

        <!-- USUARIOS -->
        <g id="user-group">
            <g transform="translate(130, 200)" id="user-node-1">
                <use href="#icon-pc"/> 
                <text x="22" y="50" class="txt-title" font-size="11">Finanzas</text>
                <text x="22" y="62" class="txt-ip" font-size="10">10.50.0.10</text>
            </g>
            <g transform="translate(130, 300)" id="user-node-2">
                <use href="#icon-pc"/> 
                <text x="22" y="50" class="txt-title" font-size="11">Soporte</text>
                <text x="22" y="62" class="txt-ip" font-size="10">10.50.0.11</text>
            </g>
            <g transform="translate(130, 400)" id="user-node-3">
                <use href="#icon-pc"/> 
                <text x="22" y="50" class="txt-title" font-size="11">Ventas</text>
                <text x="22" y="62" class="txt-ip" font-size="10">10.50.0.12</text>
            </g>
        </g>

        <!-- V√çCTIMA 1: Servidor HTTP -->
        <g id="victim-1" transform="translate(230, 530)">
            <g id="victim-inner-1">
                <circle cx="25" cy="20" r="50" fill="url(#attack-glow)" opacity="0" id="attack-glow-1"/>
                <use href="#icon-pc"/>
                <rect id="screen-v1" x="3" y="3" width="39" height="29" fill="#0a0a1e" />
                <use href="#icon-wazuh-agent" x="40" y="-10" transform="scale(1.8)" />
                <text x="58" y="-2" fill="#00d2ff" font-size="10" font-weight="bold">HIDS</text>
                <text x="22" y="55" class="txt-title" font-size="12">Web Server</text>
                <text x="22" y="68" class="txt-ip">172.60.0.101</text>
            </g>
            <!-- Visuals para Escenarios -->
            <g id="privesc-visual" style="display:none" transform="translate(50, -30)">
                 <rect width="70" height="40" fill="#222" stroke="#f00" rx="3"/>
                 <text x="35" y="15" font-size="8" fill="#fff" text-anchor="middle">Admin Group</text>
                 <text x="35" y="30" font-size="9" fill="#f00" text-anchor="middle" font-weight="bold">+ INTRUSO</text>
            </g>
             <g id="file-visual" style="display:none" transform="translate(50, -30)">
                 <rect width="30" height="35" fill="#fff" stroke="#f00" rx="2"/>
                 <text x="15" y="20" font-size="18" text-anchor="middle">‚ò¢Ô∏è</text>
                 <text x="15" y="32" font-size="6" text-anchor="middle">.exe</text>
            </g>
        </g>
        
        <!-- V√çCTIMA 2: App Server -->
        <g id="victim-2" transform="translate(360, 530)"> 
            <g id="victim-inner-2">
                <circle cx="25" cy="20" r="50" fill="url(#attack-glow)" opacity="0" id="attack-glow-2"/>
                <use href="#icon-pc"/>
                <rect id="screen-v2" x="3" y="3" width="39" height="29" fill="#0a0a1e" />
                <use href="#icon-wazuh-agent" x="40" y="-10" transform="scale(1.8)" />
                <text x="58" y="-2" fill="#00d2ff" font-size="10" font-weight="bold">HIDS</text>
                <text x="22" y="55" class="txt-title" font-size="12">App Server</text>
                <text x="22" y="68" class="txt-ip">172.60.0.102</text>
            </g>
        </g>
        
        <!-- V√çCTIMA 3: DB Server -->
        <g id="victim-3" transform="translate(490, 530)"> 
            <g id="victim-inner-3">
                <circle cx="25" cy="20" r="50" fill="url(#attack-glow)" opacity="0" id="attack-glow-3"/>
                <use href="#icon-pc"/>
                <rect id="screen-v3" x="3" y="3" width="39" height="29" fill="#0a0a1e" />
                <use href="#icon-wazuh-agent" x="40" y="-10" transform="scale(1.8)" />
                <text x="58" y="-2" fill="#00d2ff" font-size="10" font-weight="bold">HIDS</text>
                <text x="22" y="55" class="txt-title" font-size="12">DB Server</text>
                <text x="22" y="68" class="txt-ip">172.60.0.103</text>
            </g>
        </g>
        
        <!-- SURICATA (NIDS) -->
        <g transform="translate(875, 100)">
            <use href="#icon-server" transform="scale(1.6)"/>
            <text x="25" y="100" class="txt-title" fill="#e67e22" font-size="16">SURICATA</text>
            <text x="25" y="116" class="txt-title" fill="#e67e22" font-size="12">(NIDS)</text>
            <circle id="alert-led" cx="50" cy="15" r="8" fill="#333" stroke="#e67e22" stroke-width="2"/>
        </g>

        <!-- WAZUH (SIEM) -->
        <g transform="translate(875, 530)">
            <use href="#icon-server" transform="scale(1.6)"/>
            <text x="25" y="100" class="txt-title" fill="#3498db" font-size="16">WAZUH</text>
            <text x="25" y="116" class="txt-title" fill="#3498db" font-size="12">(SIEM)</text>
        </g>

        <!-- DASHBOARD ANALISTA -->
        <g transform="translate(1060, 460)">
            <rect x="0" y="0" width="130" height="80" fill="#2a2a3e" stroke="#00d2ff" stroke-width="2" rx="5"/>
            <rect id="dash-screen" x="5" y="5" width="120" height="70" fill="#111" rx="3"/>
            <text x="65" y="95" class="txt-title">Analista SOC</text>
            
            <g id="wazuh-logs" transform="translate(10, 20)" style="opacity:0">
                <text x="0" y="0" class="log-entry" id="log-1">Detecting...</text>
                <text x="0" y="12" class="log-entry" id="log-2"></text>
                <text x="0" y="24" class="log-entry" id="log-3"></text>
            </g>
        </g>

        <g id="traffic-layer"></g>

    </svg>

    <div class="controls">
        <div class="step-count" id="step-display">PASO 0/0</div>
        <div class="desc" id="step-desc">Selecciona un escenario para comenzar...</div>
        <div>
            <button onclick="prevStep()" class="ctrl-btn" id="btn-prev">‚¨Ö Anterior</button>
            <button onclick="nextStep()" class="ctrl-btn" id="btn-next">Siguiente ‚û°</button>
        </div>
    </div>
</div>

<script>
    // Variables DOM
    const trafficLayer = document.getElementById('traffic-layer');
    const elTerm = document.getElementById('kali-terminal');
    const elTermText1 = document.getElementById('term-line1');
    const elTermText2 = document.getElementById('term-line2');
    const elAlertLed = document.getElementById('alert-led');
    const elDashScreen = document.getElementById('dash-screen');
    const elWazuhLogs = document.getElementById('wazuh-logs');
    const privescVis = document.getElementById('privesc-visual');
    const fileVis = document.getElementById('file-visual');

    // Estado
    let currentScenario = 'privesc';
    let currentStep = 0;
    let normalTrafficInterval = null;
    let attackInterval = null;
    let isAttackActive = false;

    // Escenarios
    const scenarios = {
        privesc: [
            {
                txt: "üü¢ Estado Normal: Tr√°fico habitual. El Agente Wazuh monitorea los 3 servidores.",
                act: () => resetAll()
            },
            {
                txt: "üë®‚Äçüíª Atacante: Accede a una shell y crea un usuario backdoor en el Servidor Web (172.60.0.101).",
                act: () => typeCommand("net user INTRUSO27000 P@ssw0rd123 /add")
            },
            {
                txt: "‚ö° Ejecuci√≥n: El comando viaja a la v√≠ctima principal.",
                act: () => animatePacketOnPath('path-kali', '#ff0000', 8, 4, () => animatePacketOnPath('path-vic1', '#ff0000', 8, 4))
            },
            {
                txt: "üîì Escalada: El atacante a√±ade su usuario al grupo 'Administradores'.",
                act: () => typeCommand("net localgroup Administradores INTRUSO27000 /add")
            },
            {
                txt: "üõ°Ô∏è Wazuh Detecta: El agente captura eventos de seguridad ID 4720 (Creaci√≥n) y 4732 (Cambio de Grupo).",
                act: () => {
                    animatePacketOnPath('path-kali', '#ff0000', 8, 4, () => {
                         animatePacketOnPath('path-vic1', '#ff0000', 8, 4, () => {
                             privescVis.style.display = 'block'; // Mostrar visual de admin
                             showMessage(280, 510, "‚ö†Ô∏è GRP ADMIN CHANGED", "alert");
                         });
                    });
                }
            },
            {
                txt: "üì° Env√≠o de Logs: El agente env√≠a los logs cr√≠ticos al Wazuh Manager.",
                act: () => animatePacketOnPath('path-hids-log', '#00ffff', 6, 5)
            },
            {
                txt: "üö® Alerta Generada: Wazuh dispara la regla 'Administrators Group Changed' (Nivel 12).",
                act: () => showDashboardLog([
                    {t: "Rule: 60109 - User account created", c: "#fff"},
                    {t: "Rule: 60154 - Administrators Group Changed", c: "#ffcc00"}
                ])
            }
        ],
        persistence: [
            {
                txt: "üü¢ Estado Normal: El m√≥dulo FIM (File Integrity Monitoring) vigila carpetas cr√≠ticas en todos los nodos.",
                act: () => resetAll()
            },
            {
                txt: "üìÅ Preparaci√≥n: El atacante intenta instalar 'backdoor.exe' en el Servidor Web.",
                act: () => typeCommand("upload backdoor.exe C:\\...\\Start Menu\\Programs\\Startup\\")
            },
            {
                txt: "üíæ Inyecci√≥n: El archivo malicioso se escribe en la carpeta de Inicio Autom√°tico.",
                act: () => {
                    animatePacketOnPath('path-kali', '#ff0000', 6, 5, () => {
                        animatePacketOnPath('path-vic1', '#ff0000', 6, 5, () => {
                            fileVis.style.display = 'block';
                            showMessage(280, 510, "üíæ FILE WRITTEN", "alert");
                        });
                    });
                }
            },
            {
                txt: "üîç Escaneo FIM: Wazuh detecta un cambio en el sistema de archivos (syscheck).",
                act: () => {
                    fileVis.classList.add('blink');
                    showMessage(280, 490, "üîç FIM DETECTED", "hids");
                }
            },
            {
                txt: "üì° Reporte: El agente env√≠a el hash del nuevo archivo al Manager.",
                act: () => animatePacketOnPath('path-hids-log', '#00ffff', 6, 5)
            },
            {
                txt: "üö® Alerta FIM: Wazuh reporta 'File added to the system' en directorio cr√≠tico.",
                act: () => showDashboardLog([
                    {t: "FIM: File added to system", c: "#fff"},
                    {t: "File: .../Startup/backdoor.exe", c: "#ffcc00"},
                    {t: "Rule: 554", c: "#ffcc00"}
                ])
            }
        ],
        logs: [
            {
                txt: "üü¢ Estado Normal: El sistema registra todas las auditor√≠as.",
                act: () => resetAll()
            },
            {
                txt: "üßπ Cobertura de Huellas: El atacante intenta borrar los logs de eventos de Windows.",
                act: () => typeCommand("wevtutil cl Security / clearev")
            },
            {
                txt: "üóëÔ∏è Ejecuci√≥n: Se env√≠a el comando de limpieza.",
                act: () => animatePacketOnPath('path-kali', '#ff0000', 8, 4, () => animatePacketOnPath('path-vic1', '#ff0000', 8, 4))
            },
            {
                txt: "üõ°Ô∏è Detecci√≥n Inmediata: El propio acto de borrar logs genera un evento de seguridad (ID 1102).",
                act: () => showMessage(280, 510, "üóëÔ∏è LOGS CLEARED", "error")
            },
            {
                txt: "üì° Env√≠o de Alerta: El agente Wazuh captura el evento de limpieza y lo reporta.",
                act: () => animatePacketOnPath('path-hids-log', '#00ffff', 6, 5)
            },
            {
                txt: "üö® Alerta Cr√≠tica: Wazuh detecta la regla 63103 'The audit log was cleared'.",
                act: () => showDashboardLog([
                    {t: "Rule: 63103", c: "#ffcc00"},
                    {t: "Msg: The audit log was cleared", c: "#fff"}
                ])
            }
        ],
        ddos: [
             {
                txt: "üü¢ Estado Normal: Tr√°fico balanceado entre los 3 servidores.",
                act: () => { resetAll(); startNormalTraffic(); }
            },
            {
                txt: "üíª Ataque: Kali lanza 'hping3 --flood' masivo contra toda la subred.",
                act: () => typeCommand("hping3 --flood -S 172.60.0.*")
            },
            {
                txt: "üî¥ Saturaci√≥n: Paquetes masivos inundan Web, App y DB. ¬°Estr√©s total!",
                act: () => startDDoSVisuals()
            },
             {
                txt: "‚ùå Denegaci√≥n: Usuarios de Finanzas, Soporte y Ventas reciben Timeout.",
                act: () => {} // Visuals already running
            },
            {
                txt: "üîç NIDS & HIDS: Suricata detecta flujo. Wazuh detecta CPU al 100% en todos los nodos.",
                act: () => {
                    elAlertLed.setAttribute("fill", "red");
                    elAlertLed.classList.add("blink");
                    animatePacketOnPath('path-hids-log', '#00ffff', 6, 5);
                }
            },
            {
                txt: "üö® Alerta Correlacionada: Wazuh une eventos de red y host.",
                act: () => showDashboardLog([
                    {t: "DOS Attack Detected", c: "#f00"},
                    {t: "Src: 10.50.0.100 (Kali)", c: "#fff"}
                ])
            }
        ]
    };

    // Funciones Base
    function setScenario(scen) {
        currentScenario = scen;
        currentStep = 0;
        
        // Update UI buttons
        document.querySelectorAll('.btn-scenario').forEach(b => b.classList.remove('active'));
        const activeBtn = document.querySelector(`button[onclick="setScenario('${scen}')"]`);
        if(activeBtn) activeBtn.classList.add('active');

        resetAll();
        if(scen === 'ddos') startNormalTraffic();
        updateStep();
    }

    function updateStep() {
        const scenarioSteps = scenarios[currentScenario];
        document.getElementById('step-display').innerText = `PASO ${currentStep + 1}/${scenarioSteps.length}`;
        document.getElementById('step-desc').innerText = scenarioSteps[currentStep].txt;
        scenarioSteps[currentStep].act();

        document.getElementById('btn-prev').disabled = currentStep === 0;
        document.getElementById('btn-next').disabled = currentStep === scenarioSteps.length - 1;
    }

    function nextStep() {
        if (currentStep < scenarios[currentScenario].length - 1) {
            currentStep++;
            updateStep();
        }
    }

    function prevStep() {
        if (currentStep > 0) {
            currentStep--;
            updateStep();
        }
    }

    // Utilidades Visuales
    function resetAll() {
        stopDDoSVisuals();
        while (trafficLayer.firstChild) trafficLayer.removeChild(trafficLayer.firstChild);
        elTerm.style.opacity = 0;
        elAlertLed.setAttribute("fill", "#333");
        elAlertLed.classList.remove("blink");
        elDashScreen.setAttribute("fill", "#111");
        elWazuhLogs.style.opacity = 0;
        privescVis.style.display = 'none';
        fileVis.style.display = 'none';
        fileVis.classList.remove('blink');
    }

    function typeCommand(text) {
        elTerm.style.opacity = 1;
        elTermText2.textContent = "";
        elTermText1.textContent = "root@kali:~#";
        let i = 0;
        const interval = setInterval(() => {
            elTermText2.textContent += text.charAt(i);
            i++;
            if(i >= text.length) clearInterval(interval);
        }, 30);
    }

    function showDashboardLog(lines) {
        elWazuhLogs.style.opacity = 1;
        const logElements = elWazuhLogs.querySelectorAll('text');
        logElements.forEach(el => el.textContent = "");
        
        lines.forEach((line, index) => {
            if(logElements[index]) {
                logElements[index].textContent = "> " + line.t;
                logElements[index].setAttribute("fill", line.c);
            }
        });
        
        // Flash screen
        elDashScreen.setAttribute("fill", "#333");
        setTimeout(() => elDashScreen.setAttribute("fill", "#111"), 200);
    }

    function showMessage(x, y, text, type) {
        const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
        txt.textContent = text;
        txt.setAttribute("x", x);
        txt.setAttribute("y", y);
        txt.classList.add("msg-label");
        
        if (type === 'error') txt.classList.add('msg-timeout');
        else if (type === 'hids') txt.classList.add('msg-hids');
        else txt.classList.add('msg-alert');

        trafficLayer.appendChild(txt);
        setTimeout(() => { if(trafficLayer.contains(txt)) trafficLayer.removeChild(txt); }, 2500);
    }

    function createPacket(color, size) {
        const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        c.setAttribute("r", size);
        c.setAttribute("fill", color);
        c.style.filter = `drop-shadow(0 0 5px ${color})`;
        return c;
    }

    function animatePacketOnPath(pathId, color, speed, size=3, callback) {
        const path = document.getElementById(pathId);
        if(!path) return;
        
        const packet = createPacket(color, size);
        trafficLayer.appendChild(packet);
        const length = path.getTotalLength();
        let progress = 0;

        function step() {
            if(!trafficLayer.contains(packet)) return;
            progress += speed;

            if (progress > length) {
                packet.remove();
                if (callback) callback();
                return;
            }

            const pt = path.getPointAtLength(progress);
            packet.setAttribute("cx", pt.x);
            packet.setAttribute("cy", pt.y);
            requestAnimationFrame(step);
        }
        step();
    }

    // Funciones DDoS Espec√≠ficas
    function startNormalTraffic() {
        if (normalTrafficInterval) clearInterval(normalTrafficInterval);
        normalTrafficInterval = setInterval(() => {
            const userId = Math.floor(Math.random() * 3) + 1;
            const targetId = Math.floor(Math.random() * 3) + 1; // Random victim 1, 2, or 3
            
            animatePacketOnPath(`path-user${userId}`, '#00d2ff', 5, 3, () => {
                animatePacketOnPath(`path-vic${targetId}`, '#00d2ff', 5, 3, () => {
                    if (isAttackActive) {
                        // Return error packet
                        animateReversePacket(`path-vic${targetId}`, '#ff4444', 8, 3, () => {
                            animateReversePacket(`path-user${userId}`, '#ff4444', 8, 3, () => {
                                const userNode = document.getElementById(`user-node-${userId}`);
                                const transform = userNode.getAttribute('transform');
                                const coords = transform.match(/translate\(([^,]+),\s*([^)]+)\)/);
                                if(coords) showMessage(parseFloat(coords[1]) + 20, parseFloat(coords[2]), "‚õî TIMEOUT", "error");
                            });
                        });
                    }
                });
            });
        }, 1000); // Faster traffic for multiple nodes
    }

    function animateReversePacket(pathId, color, speed, size, callback) {
        const path = document.getElementById(pathId);
        if(!path) return;
        const packet = createPacket(color, size);
        trafficLayer.appendChild(packet);
        const length = path.getTotalLength();
        let progress = length;

        function step() {
            if(!trafficLayer.contains(packet)) return;
            progress -= speed;
            if (progress <= 0) {
                packet.remove();
                if (callback) callback();
                return;
            }
            const pt = path.getPointAtLength(progress);
            packet.setAttribute("cx", pt.x);
            packet.setAttribute("cy", pt.y);
            requestAnimationFrame(step);
        }
        step();
    }

    function startDDoSVisuals() {
        isAttackActive = true;
        
        // Shake ALL victims
        document.getElementById('victim-inner-1').classList.add('stress-shake');
        document.getElementById('victim-inner-2').classList.add('stress-shake');
        document.getElementById('victim-inner-3').classList.add('stress-shake');
        
        // Red screens
        document.getElementById('screen-v1').setAttribute("fill", "#500");
        document.getElementById('screen-v2').setAttribute("fill", "#500");
        document.getElementById('screen-v3').setAttribute("fill", "#500");
        
        // Glows
        document.getElementById('attack-glow-1').setAttribute("opacity", "0.6");
        document.getElementById('attack-glow-2').setAttribute("opacity", "0.6");
        document.getElementById('attack-glow-3').setAttribute("opacity", "0.6");

        if (attackInterval) clearInterval(attackInterval);
        attackInterval = setInterval(() => {
            animatePacketOnPath('path-kali', '#ff0000', 12, 5, () => {
                // Split packets to all 3 victims
                animatePacketOnPath('path-vic1', '#ff0000', 12, 5);
                animatePacketOnPath('path-vic2', '#ff0000', 12, 5);
                animatePacketOnPath('path-vic3', '#ff0000', 12, 5);
                animatePacketOnPath('path-suricata', '#e67e22', 12, 4);
            });
        }, 150);
    }

    function stopDDoSVisuals() {
        isAttackActive = false;
        
        // Stop shake
        document.getElementById('victim-inner-1').classList.remove('stress-shake');
        document.getElementById('victim-inner-2').classList.remove('stress-shake');
        document.getElementById('victim-inner-3').classList.remove('stress-shake');
        
        // Reset screens
        document.getElementById('screen-v1').setAttribute("fill", "#0a0a1e");
        document.getElementById('screen-v2').setAttribute("fill", "#0a0a1e");
        document.getElementById('screen-v3').setAttribute("fill", "#0a0a1e");
        
        // Stop glows
        document.getElementById('attack-glow-1').setAttribute("opacity", "0");
        document.getElementById('attack-glow-2').setAttribute("opacity", "0");
        document.getElementById('attack-glow-3').setAttribute("opacity", "0");

        if (attackInterval) clearInterval(attackInterval);
        if (normalTrafficInterval) clearInterval(normalTrafficInterval);
    }

    // Iniciar
    updateStep();

</script>

</body>
</html>
